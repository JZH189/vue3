# 位标志转换与快速求值技巧

## 1. 当前位标志定义分析

在Vue 3的effect.ts中，`EVALUATED = 1 << 7` 表示"是否已求值"，其二进制值为128（10000000）。

```typescript
enum EffectFlags {
  ACTIVE = 1 << 0, // 1:   00000001
  RUNNING = 1 << 1, // 2:   00000010
  TRACKING = 1 << 2, // 4:   00000100
  NOTIFIED = 1 << 3, // 8:   00001000
  DIRTY = 1 << 4, // 16:  00010000
  ALLOW_RECURSE = 1 << 5, // 32:  00100000
  PAUSED = 1 << 6, // 64:  01000000
  EVALUATED = 1 << 7, // 128: 10000000
}
```

## 2. 位标志快速求值转换方法

### 2.1 直接数值转换

```typescript
// 方法1: 直接使用十进制数值（不推荐，不够直观）
const EVALUATED_DIRECT = 128

// 方法2: 使用十六进制（更直观地表示位位置）
const EVALUATED_HEX = 0x80 // 0x80 = 128 = 10000000(二进制)

// 方法3: 使用二进制字面量（ES2015+，最直观）
const EVALUATED_BINARY = 0b10000000 // 直接显示位模式
```

### 2.2 数学公式转换

```typescript
// 位移运算的数学等价
const EVALUATED_MATH = Math.pow(2, 7) // 2^7 = 128

// 快速心算公式：2的n次方
// 1 << 0 = 2^0 = 1
// 1 << 1 = 2^1 = 2
// 1 << 2 = 2^2 = 4
// 1 << 3 = 2^3 = 8
// 1 << 4 = 2^4 = 16
// 1 << 5 = 2^5 = 32
// 1 << 6 = 2^6 = 64
// 1 << 7 = 2^7 = 128
```

### 2.3 预计算查找表（极致性能优化）

```typescript
// 为了避免运行时计算，预先计算所有位标志值
const BIT_FLAGS = [
  1, // 1 << 0
  2, // 1 << 1
  4, // 1 << 2
  8, // 1 << 3
  16, // 1 << 4
  32, // 1 << 5
  64, // 1 << 6
  128, // 1 << 7
  256, // 1 << 8
  512, // 1 << 9
  // ... 更多位
]

// 使用查找表
const EVALUATED_LOOKUP = BIT_FLAGS[7] // 128
```

## 3. 位操作快速求值技巧

### 3.1 检查位标志状态

```typescript
// 检查EVALUATED位是否设置
function isEvaluated(flags: number): boolean {
  return (flags & 128) !== 0
  // 或者使用位移：return (flags & (1 << 7)) !== 0;
}

// 快速检查多个位
function hasFlags(flags: number, mask: number): boolean {
  return (flags & mask) === mask
}

// 示例：检查是否同时设置了EVALUATED和ACTIVE
const isEvaluatedAndActive = hasFlags(flags, 128 | 1) // 129
```

### 3.2 设置位标志

```typescript
// 设置EVALUATED位
function setEvaluated(flags: number): number {
  return flags | 128
  // 或者：return flags | (1 << 7);
}

// 批量设置多个位
function setMultipleFlags(flags: number, mask: number): number {
  return flags | mask
}
```

### 3.3 清除位标志

```typescript
// 清除EVALUATED位
function clearEvaluated(flags: number): number {
  return flags & ~128
  // 或者：return flags & ~(1 << 7);
}

// 清除多个位标志
function clearMultipleFlags(flags: number, mask: number): number {
  return flags & ~mask
}
```

### 3.4 切换位标志

```typescript
// 切换EVALUATED位
function toggleEvaluated(flags: number): number {
  return flags ^ 128
  // 或者：return flags ^ (1 << 7);
}
```

## 4. 性能优化技巧

### 4.1 位掩码预计算

```typescript
// 预计算常用的位掩码组合
const COMMON_MASKS = {
  ACTIVE_AND_TRACKING: (1 << 0) | (1 << 2), // 5: 00000101
  RUNNING_OR_PAUSED: (1 << 1) | (1 << 6), // 66: 01000010
  EVALUATED_AND_DIRTY: (1 << 7) | (1 << 4), // 144: 10010000
  ALL_STATUS_FLAGS: (1 << 0) | (1 << 1) | (1 << 2) | (1 << 3), // 15
}

// 使用预计算的掩码
function isActiveAndTracking(flags: number): boolean {
  return (
    (flags & COMMON_MASKS.ACTIVE_AND_TRACKING) ===
    COMMON_MASKS.ACTIVE_AND_TRACKING
  )
}
```

### 4.2 位计数优化

```typescript
// 快速计算设置的位数（Brian Kernighan算法）
function countSetBits(flags: number): number {
  let count = 0
  while (flags) {
    flags &= flags - 1 // 清除最低位的1
    count++
  }
  return count
}

// 使用内置函数（现代浏览器）
function countSetBitsFast(flags: number): number {
  return flags.toString(2).split('1').length - 1
}
```

### 4.3 位位置快速查找

```typescript
// 找到最低位的1的位置
function findLowestBit(flags: number): number {
  return flags & -flags
}

// 找到最高位的1的位置
function findHighestBit(flags: number): number {
  let bit = 0
  while (flags) {
    flags >>= 1
    bit++
  }
  return 1 << (bit - 1)
}
```

## 5. Vue 3中的实际应用

### 5.1 computed的求值状态管理

```typescript
// 在updateComputed函数中的使用
function updateComputed(computed: ComputedRefImpl) {
  // 检查是否已求值且不脏
  if (
    computed.flags & EffectFlags.EVALUATED && // 使用位与快速检查
    !isDirty(computed)
  ) {
    return // 已求值且数据未变，直接返回
  }

  // 执行计算后设置求值标志
  if (hasChanged(newValue, computed._value)) {
    computed.flags |= EffectFlags.EVALUATED // 使用位或快速设置
  }
}
```

### 5.2 性能分析对比

```typescript
// 传统布尔属性方式（内存占用大）
interface SlowEffect {
  isActive: boolean // ~40-60字节
  isRunning: boolean // ~40-60字节
  isTracking: boolean // ~40-60字节
  isNotified: boolean // ~40-60字节
  isDirty: boolean // ~40-60字节
  isEvaluated: boolean // ~40-60字节
  // 总计: ~240-360字节
}

// 位标志方式（内存占用小）
interface FastEffect {
  flags: number // ~8字节（包含所有状态）
  // 总计: ~8字节
}

// 性能提升：内存占用减少30-45倍！
```

## 6. 转换建议

### 6.1 推荐的转换方式

```typescript
// 原始定义（推荐保持）
const EVALUATED = 1 << 7

// 如果需要预计算版本（用于热点代码）
const EVALUATED_PRECOMPUTED = 128

// 如果需要更明确的二进制表示
const EVALUATED_BINARY = 0b10000000

// 如果需要十六进制表示
const EVALUATED_HEX = 0x80
```

### 6.2 选择标准

- **开发阶段**: 使用`1 << 7`，清晰表达位位置
- **生产优化**: 考虑使用预计算值`128`
- **调试阶段**: 使用二进制`0b10000000`，直观显示位模式
- **底层优化**: 使用十六进制`0x80`，与系统级编程习惯一致

### 6.3 最佳实践

1. **保持一致性**: 团队内统一使用同一种表示方法
2. **注释说明**: 始终添加注释说明位的含义和数值
3. **类型安全**: 使用枚举确保类型安全
4. **性能测试**: 在关键路径上测试不同方式的性能差异

## 7. 总结

`EVALUATED = 1 << 7`这种位标志定义方式已经是性能和可读性的最佳平衡。如果确实需要更快的求值，可以考虑：

1. **预计算常量**: `const EVALUATED = 128`
2. **位掩码预计算**: 预计算常用的位组合
3. **内联优化**: 在热点代码中直接使用数值
4. **查找表**: 对于复杂的位操作，使用预计算的查找表

但在大多数情况下，`1 << 7`的性能已经足够好，且具有最佳的可读性和可维护性。
